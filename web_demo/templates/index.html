<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenHands SRE Web Demo</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --ink: #1d2433;
      --muted: #5b6477;
      --ok: #1f8f4e;
      --bad: #c63838;
      --accent: #1063ff;
      --line: #dbe1ec;
      --warn: #b97a00;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #e7efff, #f5f7fb 40%);
      color: var(--ink);
    }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px;
      display: grid;
      gap: 14px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(16, 24, 40, 0.06);
      padding: 14px;
    }
    .title { font-weight: 700; margin: 0 0 8px 0; }
    .sub { color: var(--muted); font-size: 13px; }
    .grid-2 { display: grid; gap: 14px; grid-template-columns: 1.2fr 1fr; }
    .grid-3 { display: grid; gap: 14px; grid-template-columns: 1fr 1fr 1fr; }
    .controls {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(6, minmax(120px, 1fr));
      align-items: end;
    }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px; }
    input, select, button {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 14px;
      background: #fff;
    }
    input[type="checkbox"] { width: auto; }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      font-weight: 600;
      cursor: pointer;
    }
    .btn-secondary { cursor: pointer; }
    .kpis {
      display: grid;
      grid-template-columns: repeat(8, minmax(90px, 1fr));
      gap: 10px;
    }
    .kpi {
      background: #f7f9fe;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px;
    }
    .kpi .v { font-size: 18px; font-weight: 700; }
    .kpi .k { font-size: 11px; color: var(--muted); text-transform: uppercase; }
    .ok { color: var(--ok); }
    .bad { color: var(--bad); }
    .warn { color: var(--warn); }
    .rows {
      max-height: 280px;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
    }
    th { position: sticky; top: 0; background: #f6f8fc; z-index: 1; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }
    .logs {
      max-height: 180px;
      overflow: auto;
      background: #0f1320;
      color: #d3d9ea;
      border-radius: 10px;
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      line-height: 1.4;
    }
    .pill {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      border: 1px solid var(--line);
      background: #f6f8fc;
    }
    @media (max-width: 980px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
      .controls { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
      .kpis { grid-template-columns: repeat(4, minmax(90px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <h2 class="title">OpenHands Fan-Out Web Demo</h2>
      <div class="sub">Stable live view for multi-agent orchestration with optional trace links.</div>
      <div class="controls" style="margin-top:10px;">
        <div>
          <label>Mode</label>
          <select id="mode">
            <option value="optimized" selected>optimized</option>
            <option value="baseline">baseline</option>
          </select>
        </div>
        <div>
          <label>Optimizer</label>
          <select id="optimizer">
            <option value="gepa" selected>gepa</option>
            <option value="iterative">iterative</option>
            <option value="manual">manual</option>
          </select>
        </div>
        <div>
          <label>Incidents</label>
          <input id="incidents" type="number" value="24" min="1" max="1000" />
        </div>
        <div>
          <label>Concurrency</label>
          <input id="concurrency" type="number" value="4" min="1" max="32" />
        </div>
        <div>
          <label>Seed</label>
          <input id="seed" type="number" value="7" />
        </div>
        <div>
          <label>Simulation</label>
          <select id="simulate">
            <option value="true" selected>true</option>
            <option value="false">false</option>
          </select>
        </div>
        <div>
          <label>Target URL</label>
          <input id="target_url" type="text" value="http://127.0.0.1:15000" />
        </div>
        <div>
          <label>Target Container</label>
          <input id="target_container" type="text" value="openhands-gepa-demo" />
        </div>
        <div style="grid-column: span 2;">
          <label>OpenHands Remote Host (required for real mode)</label>
          <input id="remote_host" type="text" placeholder="http://127.0.0.1:3000" />
        </div>
        <div>
          <label>Allow Local Workspace</label>
          <select id="allow_local_workspace">
            <option value="false" selected>false</option>
            <option value="true">true</option>
          </select>
        </div>
        <div style="grid-column: span 3;">
          <label>Trace URL Template (optional)</label>
          <input id="trace" type="text" placeholder="https://...traceId={trace_id}" />
        </div>
        <div>
          <label>Simulation Latency (ms)</label>
          <input id="simulate_latency_ms" type="number" value="250" min="0" max="10000" />
        </div>
        <div>
          <label>Real Retries</label>
          <input id="real_max_retries" type="number" value="2" min="0" max="10" />
        </div>
        <div>
          <label>Real Timeout (s)</label>
          <input id="real_run_timeout_s" type="number" value="180" min="30" max="1800" />
        </div>
        <div>
          <label>Status</label>
          <div><span id="status" class="pill">idle</span></div>
        </div>
        <div>
          <button class="btn-primary" id="startBtn">Start Run</button>
        </div>
        <div>
          <button class="btn-secondary" id="stopBtn">Stop</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="kpis">
        <div class="kpi"><div class="k">Total</div><div id="k_total" class="v">0</div></div>
        <div class="kpi"><div class="k">Queue</div><div id="k_queue" class="v">0</div></div>
        <div class="kpi"><div class="k">Active</div><div id="k_active" class="v">0</div></div>
        <div class="kpi"><div class="k">Completed</div><div id="k_completed" class="v">0</div></div>
        <div class="kpi"><div class="k">Fixed</div><div id="k_fixed" class="v ok">0</div></div>
        <div class="kpi"><div class="k">Failed</div><div id="k_failed" class="v bad">0</div></div>
        <div class="kpi"><div class="k">Avg Steps</div><div id="k_avg_steps" class="v">0</div></div>
        <div class="kpi"><div class="k">Thru/s</div><div id="k_tps" class="v">0</div></div>
      </div>
      <div class="sub" style="margin-top:10px;">
        Run ID: <span id="run_id" class="mono">-</span>
        <span style="margin-left:16px;">Strategy Score: <span id="strategy_score" class="mono">-</span></span>
      </div>
    </div>

    <div class="grid-2">
      <div class="panel">
        <h3 class="title">Active Workers</h3>
        <div class="rows">
          <table>
            <thead>
              <tr><th>Worker</th><th>Incident</th><th>Severity</th><th>Scenario</th></tr>
            </thead>
            <tbody id="active_body"></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h3 class="title">Queue</h3>
        <div class="rows">
          <table>
            <thead>
              <tr><th>Incident</th><th>Severity</th><th>Scenario</th></tr>
            </thead>
            <tbody id="queue_body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="grid-2">
      <div class="panel">
        <h3 class="title">Recent Completions</h3>
        <div class="rows">
          <table>
            <thead>
              <tr><th>Incident</th><th>Worker</th><th>Status</th><th>Steps</th><th>Risk</th><th>Trace</th></tr>
            </thead>
            <tbody id="completed_body"></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h3 class="title">Run Log</h3>
        <div id="logs" class="logs"></div>
      </div>
    </div>
  </div>

  <script>
    const el = (id) => document.getElementById(id);

    function esc(x) {
      return String(x ?? "").replace(/[&<>"']/g, (c) => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"})[c]);
    }

    async function api(path, method="GET", body=null) {
      const opts = { method, headers: { "Content-Type": "application/json" } };
      if (body) opts.body = JSON.stringify(body);
      const r = await fetch(path, opts);
      return await r.json();
    }

    function setStatus(status) {
      const n = el("status");
      n.textContent = status;
      n.className = "pill";
      if (status === "running") n.classList.add("warn");
      if (status === "failed") n.classList.add("bad");
      if (status === "completed") n.classList.add("ok");
    }

    function renderRows(state) {
      const s = state.summary || {};
      el("k_total").textContent = s.total ?? 0;
      el("k_queue").textContent = s.queue ?? 0;
      el("k_active").textContent = s.active ?? 0;
      el("k_completed").textContent = s.completed ?? 0;
      el("k_fixed").textContent = s.fixed ?? 0;
      el("k_failed").textContent = s.failed ?? 0;
      el("k_avg_steps").textContent = s.avg_steps ?? 0;
      el("k_tps").textContent = s.throughput_per_s ?? 0;

      el("run_id").textContent = state.run_id || "-";
      el("strategy_score").textContent = state.config?.strategy_score ?? "-";
      setStatus(state.status || "idle");

      const active = state.active || [];
      el("active_body").innerHTML = active.length
        ? active.map(a => `<tr><td>${esc(a.worker_id)}</td><td class="mono">${esc(a.incident_id)}</td><td>${esc(a.severity)}</td><td>${esc(a.scenario_id)}</td></tr>`).join("")
        : `<tr><td colspan="4" class="sub">No active workers</td></tr>`;

      const queue = state.queue || [];
      el("queue_body").innerHTML = queue.length
        ? queue.slice(0, 60).map(q => `<tr><td class="mono">${esc(q.id)}</td><td>${esc(q.severity)}</td><td>${esc(q.scenario_id)}</td></tr>`).join("")
        : `<tr><td colspan="3" class="sub">Queue empty</td></tr>`;

      const completed = (state.completed || []).slice(-80).reverse();
      el("completed_body").innerHTML = completed.length
        ? completed.map(c => {
            const status = c.service_up ? "FIXED" : "FAILED";
            const scls = c.service_up ? "ok" : "bad";
            const trace = c.trace_url
              ? `<a href="${esc(c.trace_url)}" target="_blank" rel="noopener">open</a>`
              : `<span class="mono">${esc(c.trace_key || "-")}</span>`;
            return `<tr>
              <td class="mono">${esc(c.incident_id)}</td>
              <td>${esc(c.worker_id)}</td>
              <td class="${scls}">${status}</td>
              <td>${esc(c.step_count)}</td>
              <td>${esc(c.max_security_risk_seen)}</td>
              <td>${trace}</td>
            </tr>`;
          }).join("")
        : `<tr><td colspan="6" class="sub">No completions yet</td></tr>`;

      const logs = (state.logs || []).slice(-150);
      el("logs").innerHTML = logs.map(l => {
        const t = new Date((l.ts || 0) * 1000).toLocaleTimeString();
        return `${esc(t)}  ${esc(l.message)}`;
      }).join("<br>");
      el("logs").scrollTop = el("logs").scrollHeight;
    }

    async function refresh() {
      try {
        const s = await api("/api/state");
        renderRows(s);
      } catch (e) {
        console.error(e);
      }
    }

    async function startRun() {
      const payload = {
        mode: el("mode").value,
        optimizer: el("optimizer").value,
        incidents: Number(el("incidents").value || 24),
        concurrency: Number(el("concurrency").value || 4),
        seed: Number(el("seed").value || 7),
        simulate: el("simulate").value === "true",
        target_url: el("target_url").value || "http://127.0.0.1:15000",
        target_container: el("target_container").value || null,
        remote_host: el("remote_host").value || null,
        allow_local_workspace: el("allow_local_workspace").value === "true",
        trace_url_template: el("trace").value || null,
        simulate_latency_ms: Number(el("simulate_latency_ms").value || 0),
        real_max_retries: Number(el("real_max_retries").value || 2),
        real_run_timeout_s: Number(el("real_run_timeout_s").value || 180),
      };
      const r = await api("/api/run", "POST", payload);
      if (!r.ok) {
        alert(r.message || "Run start failed");
      }
      await refresh();
    }

    async function stopRun() {
      await api("/api/stop", "POST", {});
      await refresh();
    }

    el("startBtn").addEventListener("click", startRun);
    el("stopBtn").addEventListener("click", stopRun);

    refresh();
    setInterval(refresh, 1000);
  </script>
</body>
</html>
